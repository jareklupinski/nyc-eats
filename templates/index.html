<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NYC Eats ‚Äî Every Restaurant in New York City</title>
  <meta name="description" content="Interactive map of {{ "{:,}".format(venue_count) }} restaurants, bars, and liquor licenses across NYC. Built from DOHMH inspections, SLA licenses, cross-referenced with Yelp and Google Maps.">
  <meta name="author" content="Jarek Lupinski">
  <meta name="theme-color" content="#2563eb">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="NYC Eats">
  <meta property="og:description" content="Interactive map of {{ "{:,}".format(venue_count) }} restaurants, bars, and liquor licenses across all five boroughs.">
  <meta property="og:image" content="https://food.lupin.ski/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://food.lupin.ski">
  <meta property="og:site_name" content="NYC Eats">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="NYC Eats">
  <meta name="twitter:description" content="Interactive map of {{ "{:,}".format(venue_count) }} restaurants, bars, and liquor licenses across NYC.">
  <meta name="twitter:image" content="https://food.lupin.ski/og-image.png">

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <link rel="stylesheet" href="style.css?v={{ css_hash }}">
</head>
<body>

<div id="sidebar">
  <!-- Header -->
  <div class="sidebar-header">
    <span class="sidebar-title">NYC Eats</span>
    <a href="https://github.com/jareklupinski/nyc-eats" target="_blank" rel="noopener" class="gh-link" title="View on GitHub"><svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a>
  </div>

  <hr class="sidebar-divider">

  <!-- Search -->
  <div class="search-wrap">
    <input type="text" id="search-input" placeholder="Search map‚Ä¶">
    <button id="search-clear" type="button" aria-label="Clear"></button>
    <button id="apply-btn" type="button" aria-label="Search"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="10.5" cy="10.5" r="7"/><path d="M15.5 15.5L21 21"/></svg></button>
  </div>

  <hr class="sidebar-divider">

  <!-- Sources -->
  <div class="section-header">
    <span class="section-title">Sources</span>
    <button id="pipeline-info-btn" type="button" class="info-btn" title="Data pipeline">‚ìò</button>
  </div>
  <div class="filter-row" id="source-filters">
    <label><input type="radio" name="source" value="all" checked> Both</label>
    <label><input type="radio" name="source" value="dohmh"> Dept of Health</label>
    <label><input type="radio" name="source" value="sla"> State Liquor</label>
  </div>

  <hr class="sidebar-divider">

  {% if all_diets %}
  <!-- Diet -->
  <div class="section-header">
    <span class="section-title">Diet</span>
    <button id="diet-info-btn" type="button" class="info-btn" title="Diet data sources">‚ìò</button>
  </div>
  <div class="filter-row" id="diet-filters">
    <label><input type="radio" name="diet" value="" checked> All</label>
    {% for d in all_diets %}
    <label><input type="radio" name="diet" value="{{ d | e }}"> {{ d | e | capitalize }}</label>
    {% endfor %}
  </div>

  <hr class="sidebar-divider">
  {% endif %}

  <!-- Flags -->
  <div class="section-header">
    <span class="section-title">Flags</span>
    <button id="flags-info-btn" type="button" class="info-btn" title="About discovery flags">‚ìò</button>
  </div>
  <div class="filter-row badge-section">
    <div id="badge-filters" class="badge-filters">
      <button class="badge-filter-btn" data-badge="google-gem"><span style="color:#2563eb">G</span> Google Gems</button>
      <button class="badge-filter-btn" data-badge="yelp-gem"><span style="color:#dc2626">Y</span> Yelp Gems</button>
      <button class="badge-filter-btn" data-badge="new-venue"><span style="color:#f59e0b">‚è±</span> New</button>
      <button class="badge-filter-btn" data-badge="not-on-yelp"><span style="color:#dc2626">‚òÖ</span> No Yelp</button>
      <button class="badge-filter-btn" data-badge="not-on-google"><span style="color:#2563eb">‚òÖ</span> No Google</button>
      <button class="badge-filter-btn" data-badge="any">All flagged</button>
    </div>
    <div id="xr-venue-list" class="xr-venue-list"></div>
  </div>

  <hr class="sidebar-divider">

  <!-- Updated timestamp -->
  <div class="sidebar-updated">Updated: ‡ºº „Å§ ‚óï_‚óï ‡ºΩ„Å§ {{ build_time[:10] }}</div>
</div>

<!-- Citation Modal (Diet) -->
<div id="cite-modal" class="modal-overlay" hidden>
  <div class="modal-content">
    <button class="modal-close" data-modal="cite-modal">&times;</button>
    <h2>Diet Data Sources</h2>
    <table class="cite-table">
      <thead><tr><th>Diet</th><th>Source</th><th>Count</th></tr></thead>
      <tbody>
        {% for diet, src_map in diet_source_stats.items() | sort %}
        {% for src, cnt in src_map.items() | sort(attribute='1', reverse=true) %}
        <tr>
          {% if loop.first %}<td rowspan="{{ src_map | length }}"><strong>{{ diet }}</strong></td>{% endif %}
          <td>{{ src }}</td>
          <td>{{ cnt }}</td>
        </tr>
        {% endfor %}
        {% endfor %}
      </tbody>
    </table>
    <h3>Authoritative Sources</h3>
    <div class="cite-links">
      <a href="https://www.hmsusa.org/certified-listing" target="_blank" rel="noopener" class="cite-link">
        <svg viewBox="0 0 16 16" width="16" height="16"><circle cx="8" cy="8" r="7" fill="#065f46"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="10" font-weight="700" font-family="sans-serif">H</text></svg>
        HMS USA &mdash; Halal certified ({{ hms_matched }} matched)
      </a>
      <a href="https://koshernear.me/" target="_blank" rel="noopener" class="cite-link">
        <svg viewBox="0 0 16 16" width="16" height="16"><circle cx="8" cy="8" r="7" fill="#1e40af"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="10" font-weight="700" font-family="sans-serif">K</text></svg>
        KosherNearMe &mdash; Kosher listings ({{ knm_matched }} matched)
      </a>
    </div>
    <h3>Supplementary Sources</h3>
    <div class="cite-links">
      <a href="https://data.cityofnewyork.us/Health/DOHMH-New-York-City-Restaurant-Inspection-Results/43nn-pn8j" target="_blank" rel="noopener" class="cite-link">
        <svg viewBox="0 0 16 16" width="16" height="16"><rect x="1" y="1" width="14" height="14" rx="3" fill="#6b7280"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">D</text></svg>
        DOHMH &mdash; NYC restaurant inspection cuisine field
      </a>
      <a href="https://www.yelp.com/" target="_blank" rel="noopener" class="cite-link">
        <svg viewBox="0 0 16 16" width="16" height="16"><rect x="1" y="1" width="14" height="14" rx="3" fill="#dc2626"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">Y</text></svg>
        Yelp &mdash; Business category tags
      </a>
      <span class="cite-link cite-muted">
        <svg viewBox="0 0 16 16" width="16" height="16"><rect x="1" y="1" width="14" height="14" rx="3" fill="#9ca3af"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">N</text></svg>
        Name &mdash; Venue name contains keyword
      </span>
    </div>
    <h3>Venue Data</h3>
    <ul class="cite-sources">
      {% for src in sources %}
      <li><strong>{{ src.name | e }}</strong>: {{ src.description | e }} ({{ "{:,}".format(src.count) }} venues)</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Pipeline Modal (Sources) -->
<div id="pipeline-modal" class="modal-overlay" hidden>
  <div class="modal-content">
    <button class="modal-close" data-modal="pipeline-modal">&times;</button>
    <h2>Data Pipeline</h2>
    <p class="modal-intro">{{ "{:,}".format(venue_count) }} venues built from public government datasets, cross-referenced with Yelp and Google Maps.</p>
    <table class="pipeline-table">
      <thead><tr><th>Step</th><th>Result</th></tr></thead>
      <tbody>
        <tr><td>Raw input</td><td>{{ "{:,}".format(merge_stats.pre_merge) }} venues</td></tr>
        {% for s in pipeline_stats %}
        <tr><td>{{ s.label | e }}</td><td>&minus;{{ "{:,}".format(s.removed) }} ({{ s.detail | e }})</td></tr>
        {% endfor %}
        <tr><td>Pass 1 &mdash; exact address + borough</td><td>{{ "{:,}".format(merge_stats.pass1) }} merges</td></tr>
        <tr><td>Pass 2 &mdash; address range containment</td><td>{{ "{:,}".format(merge_stats.pass2) }} merges</td></tr>
        <tr><td>Pass 3 &mdash; geo-proximity &le; 30 m</td><td>{{ "{:,}".format(merge_stats.pass3) }} merges</td></tr>
        <tr class="pipeline-total"><td>Final</td><td>{{ "{:,}".format(merge_stats.post_merge) }} venues ({{ "{:,}".format(merge_stats.total_merges) }} merged)</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Flags Modal -->
<div id="flags-modal" class="modal-overlay" hidden>
  <div class="modal-content">
    <button class="modal-close" data-modal="flags-modal">&times;</button>
    <h2>Discovery Flags</h2>
    <p class="modal-intro">Every venue is cross-referenced against Yelp and Google Maps. Flags highlight places that may be under-discovered &mdash; restaurants that haven&rsquo;t paid for prominent listings, or are too new to have accumulated reviews. The goal is to surface great local spots that algorithms might otherwise bury.</p>
    <h3>Flag Types</h3>
    <ul class="xr-legend">
      <li><span class="xr-badge-icon" style="color:#2563eb">G</span> <strong>Google hidden gem</strong> &mdash; Found on Google with &lt;100 reviews but &gt;4&thinsp;‚òÖ. Quietly excellent.</li>
      <li><span class="xr-badge-icon" style="color:#dc2626">Y</span> <strong>Yelp hidden gem</strong> &mdash; Found on Yelp with &lt;100 reviews but &gt;4&thinsp;‚òÖ. Worth a visit.</li>
      <li><span class="xr-badge-icon" style="color:#f59e0b">‚è±</span> <strong>New</strong> &mdash; Opened less than one month ago. Give them a chance.</li>
      <li><span class="xr-badge-icon" style="color:#dc2626">‚òÖ</span> <strong>Not on Yelp</strong> &mdash; Licensed or inspected, but Yelp doesn&rsquo;t know about them.</li>
      <li><span class="xr-badge-icon" style="color:#2563eb">‚òÖ</span> <strong>Not on Google</strong> &mdash; Licensed or inspected, but missing from Google Maps entirely.</li>
    </ul>
  </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Venue data (generated at build time) -->
<script src="venues.js?v={{ data_hash }}"></script>

<script>
(function () {
  "use strict";

  // --- Diet source metadata: icon SVGs + citation URLs ---
  const DIET_SRC = {
    "HMS USA": {
      icon: `<svg viewBox="0 0 16 16" width="12" height="12"><circle cx="8" cy="8" r="7" fill="#065f46" stroke="#065f46" stroke-width="1"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="10" font-weight="700" font-family="sans-serif">H</text></svg>`,
      url: "https://www.hmsusa.org/certified-listing",
      label: "HMS USA certified halal",
      color: "#065f46",
    },
    "KosherNearMe": {
      icon: `<svg viewBox="0 0 16 16" width="12" height="12"><circle cx="8" cy="8" r="7" fill="#1e40af" stroke="#1e40af" stroke-width="1"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="10" font-weight="700" font-family="sans-serif">K</text></svg>`,
      url: "https://koshernear.me/",
      label: "KosherNearMe listing",
      color: "#1e40af",
    },
    "DOHMH": {
      icon: `<svg viewBox="0 0 16 16" width="12" height="12"><rect x="1" y="1" width="14" height="14" rx="3" fill="#6b7280" stroke="#6b7280" stroke-width="1"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">D</text></svg>`,
      url: "https://data.cityofnewyork.us/Health/DOHMH-New-York-City-Restaurant-Inspection-Results/43nn-pn8j",
      label: "DOHMH cuisine classification",
      color: "#6b7280",
    },
    "Yelp": {
      icon: `<svg viewBox="0 0 16 16" width="12" height="12"><rect x="1" y="1" width="14" height="14" rx="3" fill="#dc2626" stroke="#dc2626" stroke-width="1"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">Y</text></svg>`,
      url: "https://www.yelp.com/",
      label: "Yelp category",
      color: "#dc2626",
    },
    "Name": {
      icon: `<svg viewBox="0 0 16 16" width="12" height="12"><rect x="1" y="1" width="14" height="14" rx="3" fill="#9ca3af" stroke="#9ca3af" stroke-width="1"/><text x="8" y="11.5" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="sans-serif">N</text></svg>`,
      url: null,
      label: "Venue name keyword",
      color: "#9ca3af",
    },
  };

  function dietTagHtml(diet, srcName) {
    const meta = DIET_SRC[srcName];
    if (!meta) return `<span class="diet-tag">${escHtml(diet)}</span>`;
    const inner = meta.url
      ? `<a href="${meta.url}" target="_blank" rel="noopener" class="diet-src-link" title="${escHtml(meta.label)}">${meta.icon}</a>`
      : `<span class="diet-src-icon" title="${escHtml(meta.label)}">${meta.icon}</span>`;
    return `<span class="diet-tag">${escHtml(diet)}${inner}</span>`;
  }

  // --- Map setup ---
  const map = L.map("map", {
    center: [40.7128, -74.006],
    zoom: 11,
    preferCanvas: true,          // much faster for many markers
    maxZoom: 19,
  });

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    maxZoom: 19,
  }).addTo(map);

  // --- Marker cluster layer ---
  const clusterGroup = L.markerClusterGroup({
    chunkedLoading: true,        // don't freeze the UI
    chunkInterval: 100,
    chunkDelay: 10,
    maxClusterRadius: function(zoom) {
      // Aggressive clustering at low zoom, minimal at street level
      if (zoom >= 18) return 5;
      if (zoom >= 16) return 15;
      if (zoom >= 14) return 30;
      return 50;
    },
    spiderfyOnMaxZoom: true,
    spiderfyOnEveryZoom: true,
    spiderfyDistanceMultiplier: 1.5,
  });
  map.addLayer(clusterGroup);

  // --- Marker icons by source + grade ---
  const COLORS = {
    dohmh: "#2563eb",   // blue
    both:  "#7c3aed",   // purple
    sla:   "#dc2626",   // red
  };
  const DEFAULT_COLOR = "#6b7280";

  // Icon cache to avoid creating thousands of duplicate DOM icon objects
  const iconCache = {};

  // Build date for "new venue" detection (opened < 1 month ago)
  const NOW = new Date();
  const ONE_MONTH_AGO = new Date(NOW);
  ONE_MONTH_AGO.setMonth(ONE_MONTH_AGO.getMonth() - 1);
  const ONE_MONTH_AGO_STR = ONE_MONTH_AGO.toISOString().slice(0, 10);

  // --- Badge detection ---
  // Returns array of badge objects for a venue (can have multiple)
  function venueBadges(venue) {
    const badges = [];
    // Google hidden gem: found on Google, <100 reviews, >4 stars
    if (venue.xr_g === "found" && venue.gr != null && venue.gr < 100 && venue.grt != null && venue.grt > 4) {
      badges.push({ type: "google-gem", label: "G", color: "#2563eb", cls: "badge-g" });
    }
    // Yelp hidden gem: found on Yelp, <100 reviews, >4 stars
    if (venue.xr_y === "found" && venue.yr != null && venue.yr < 100 && venue.yrt != null && venue.yrt > 4) {
      badges.push({ type: "yelp-gem", label: "Y", color: "#dc2626", cls: "badge-y" });
    }
    // New venue: opened less than 1 month ago
    if (venue.opened && venue.opened >= ONE_MONTH_AGO_STR) {
      badges.push({ type: "new-venue", label: "\u23F1", color: "#f59e0b", cls: "badge-new" });
    }
    // Not on Yelp
    if (venue.xr_y === "not_found") {
      badges.push({ type: "not-on-yelp", label: "\u2605", color: "#dc2626", cls: "xr-red" });
    }
    // Not on Google
    if (venue.xr_g === "not_found") {
      badges.push({ type: "not-on-google", label: "\u2605", color: "#2563eb", cls: "xr-blue" });
    }
    return badges;
  }

  // Legacy compat ‚Äî returns the top-priority badge for the marker icon
  function topBadge(venue) {
    const b = venueBadges(venue);
    return b.length ? b[0] : null;
  }

  function makeIcon(venue) {
    const src = venue.source;
    const grade = (venue.grade || "").trim().toUpperCase();

    let label, color, cls;

    if (src === "sla") {
      label = "\uD83C\uDF78";  // üç∏
      color = COLORS.sla;
      cls = "vm-martini";
    } else if (src === "both") {
      label = (grade && grade !== "P" && grade !== "N" && grade !== "Z") ? grade : "?";
      color = COLORS.both;
      cls = "vm-letter";
    } else {
      label = (grade && grade !== "P" && grade !== "N" && grade !== "Z") ? grade : "?";
      color = COLORS.dohmh;
      cls = "vm-letter";
    }

    const badge = topBadge(venue);
    const badgeHtml = badge ? `<span class="xr-star" style="color:${badge.color}">${badge.label}</span>` : "";
    const badgeKey = badge ? badge.cls : "none";

    const key = `${cls}-${color}-${label}-${badgeKey}`;
    if (!iconCache[key]) {
      iconCache[key] = L.divIcon({
        className: `venue-marker ${cls}${badge ? ' has-star' : ''}`,
        html: `<span style="color:${color}">${label}</span>${badgeHtml}`,
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });
    }
    return iconCache[key];
  }

  // --- Build markers ---
  const allMarkers = [];

  for (const v of VENUE_DATA) {
    if (v.lat == null || v.lng == null) continue;
    const popupParts = [`<strong>${escHtml(v.name)}</strong>`];
    if (v.sla_name && v.sla_name.toLowerCase() !== v.name.toLowerCase()) {
      popupParts.push(`<em class="popup-aka">SLA: ${escHtml(v.sla_name)}</em>`);
    }
    if (v.cuisine) popupParts.push(escHtml(v.cuisine));
    if (v.diet && v.diet.length) {
      const src = v.diet_src || {};
      popupParts.push(`<span class="popup-diet">${v.diet.map(d => dietTagHtml(d, src[d])).join(" ")}</span>`);
    }
    if (v.address) popupParts.push(escHtml(v.address));
    if (v.borough) popupParts.push(escHtml(v.borough));
    if (v.grade)   popupParts.push(`Grade: ${escHtml(v.grade)}`);
    if (v.phone)   popupParts.push(escHtml(v.phone));
    popupParts.push(`<span class="popup-source">${escHtml(v.source)}</span>`);
    if (v.tags && v.tags.length) {
      popupParts.push(`<span class="popup-tags">${v.tags.map(escHtml).join(", ")}</span>`);
    }
    // Cross-ref badges
    const badges = venueBadges(v);
    if (badges.length) {
      for (const b of badges) {
        if (b.type === "google-gem") {
          popupParts.push(`<span class="xr-badge" style="color:${b.color}">G Google hidden gem (${v.grt}‚òÖ, ${v.gr} reviews)</span>`);
        } else if (b.type === "yelp-gem") {
          popupParts.push(`<span class="xr-badge" style="color:${b.color}">Y Yelp hidden gem (${v.yrt}‚òÖ, ${v.yr} reviews)</span>`);
        } else if (b.type === "new-venue") {
          popupParts.push(`<span class="xr-badge" style="color:${b.color}">‚è± Opened ${v.opened}</span>`);
        } else if (b.type === "not-on-yelp") {
          popupParts.push(`<span class="xr-badge" style="color:${b.color}">‚òÖ Not on Yelp</span>`);
        } else if (b.type === "not-on-google") {
          popupParts.push(`<span class="xr-badge" style="color:${b.color}">‚òÖ Not on Google Maps</span>`);
        }
      }
    }
    // Review counts / ratings
    const reviewParts = [];
    if (v.yr != null) {
      reviewParts.push(`Yelp: ${v.yrt != null ? v.yrt + '‚òÖ' : '?'} (${v.yr} reviews)`);
    }
    if (v.gr != null) {
      reviewParts.push(`Google: ${v.grt != null ? v.grt + '‚òÖ' : '?'} (${v.gr} reviews)`);
    }
    if (reviewParts.length) {
      popupParts.push(`<span class="popup-reviews">${reviewParts.join(' ¬∑ ')}</span>`);
    }

    const marker = L.marker([v.lat, v.lng], { icon: makeIcon(v) });
    marker.bindPopup(popupParts.join("<br>"), { maxWidth: 260 });

    // Attach venue data for filtering
    marker._venue = v;
    allMarkers.push(marker);
  }

  // Initial add
  clusterGroup.addLayers(allMarkers);

  // --- Filtering ---
  const searchInput = document.getElementById("search-input");
  const applyBtn = document.getElementById("apply-btn");
  const clearBtn = document.getElementById("search-clear");

  applyBtn.addEventListener("click", applyFilters);
  clearBtn.addEventListener("click", () => { searchInput.value = ""; clearBtn.style.display = "none"; applyFilters(); });
  searchInput.addEventListener("keyup", e => { if (e.key === "Enter") applyFilters(); });
  // Toggle clear button visibility
  searchInput.addEventListener("input", () => {
    clearBtn.style.display = searchInput.value ? "inline-flex" : "none";
  });

  // Source & diet radios auto-apply
  document.querySelectorAll('input[name="source"], input[name="diet"]').forEach(r =>
    r.addEventListener("change", applyFilters)
  );

  function applyFilters() {
    const srcVal = document.querySelector('input[name="source"]:checked').value;
    const dietVal = document.querySelector('input[name="diet"]:checked').value;
    const query = searchInput.value.trim().toLowerCase();

    clusterGroup.clearLayers();

    const visible = allMarkers.filter(m => {
      const v = m._venue;
      // Source filter
      if (srcVal === "dohmh" && v.source !== "dohmh" && v.source !== "both") return false;
      if (srcVal === "sla" && v.source !== "sla" && v.source !== "both") return false;
      // Diet filter
      if (dietVal && (!v.diet || !v.diet.includes(dietVal))) return false;
      // Search
      if (query) {
        const hay = [v.name, v.cuisine, v.address, v.borough, ...(v.diet || [])].join(" ").toLowerCase();
        if (!hay.includes(query)) return false;
      }
      return true;
    });

    clusterGroup.addLayers(visible);
  }

  // --- Modals ---
  function openModal(id) { document.getElementById(id).hidden = false; }
  function closeModal(id) { document.getElementById(id).hidden = true; }

  // Close buttons
  document.querySelectorAll(".modal-close").forEach(btn =>
    btn.addEventListener("click", () => closeModal(btn.dataset.modal))
  );
  // Click backdrop to close
  document.querySelectorAll(".modal-overlay").forEach(el =>
    el.addEventListener("click", e => { if (e.target === el) el.hidden = true; })
  );

  // Diet info button opens citation modal
  const dietInfoBtn = document.getElementById("diet-info-btn");
  if (dietInfoBtn) dietInfoBtn.addEventListener("click", () => openModal("cite-modal"));

  // Pipeline info button opens pipeline modal
  const pipelineInfoBtn = document.getElementById("pipeline-info-btn");
  if (pipelineInfoBtn) pipelineInfoBtn.addEventListener("click", () => openModal("pipeline-modal"));

  // Flags info button opens flags modal
  const flagsInfoBtn = document.getElementById("flags-info-btn");
  if (flagsInfoBtn) flagsInfoBtn.addEventListener("click", () => openModal("flags-modal"));

  function escHtml(s) {
    const div = document.createElement("div");
    div.textContent = s || "";
    return div.innerHTML;
  }

  // --- Badge filters ---
  const xrList = document.getElementById("xr-venue-list");
  let activeBadgeFilter = null;

  function markersForBadge(type) {
    return allMarkers.filter(m => {
      const badges = venueBadges(m._venue);
      if (type === "any") return badges.length > 0;
      return badges.some(b => b.type === type);
    });
  }

  document.querySelectorAll(".badge-filter-btn").forEach(btn => {
    const type = btn.dataset.badge;
    const count = markersForBadge(type).length;
    btn.innerHTML += ` (${count})`;
    if (count === 0) btn.style.opacity = "0.4";

    btn.addEventListener("click", () => {
      const wasActive = btn.classList.contains("active");
      document.querySelectorAll(".badge-filter-btn").forEach(b => b.classList.remove("active"));
      clusterGroup.clearLayers();
      xrList.innerHTML = "";

      if (wasActive) {
        activeBadgeFilter = null;
        clusterGroup.addLayers(allMarkers);
      } else {
        activeBadgeFilter = type;
        btn.classList.add("active");
        const filtered = markersForBadge(type);
        clusterGroup.addLayers(filtered);
        xrList.innerHTML = filtered.map(m => {
          const v = m._venue;
          const badges = venueBadges(v);
          const top = type === "any" ? badges[0] : badges.find(b => b.type === type) || badges[0];
          let detail = "";
          if (top.type === "google-gem") detail = `${v.grt}‚òÖ ¬∑ ${v.gr} reviews`;
          else if (top.type === "yelp-gem") detail = `${v.yrt}‚òÖ ¬∑ ${v.yr} reviews`;
          else if (top.type === "new-venue") detail = `opened ${v.opened}`;
          return `<a class="xr-venue-item" data-lat="${v.lat}" data-lng="${v.lng}" style="border-left:3px solid ${top.color}">` +
            `<span class="xr-badge-icon" style="color:${top.color}">${top.label}</span> ${escHtml(v.name)}` +
            `<small>${detail || escHtml(v.address || "")}</small></a>`;
        }).join("");
        xrList.querySelectorAll(".xr-venue-item").forEach((el, i) => {
          el.addEventListener("click", () => {
            map.setView([parseFloat(el.dataset.lat), parseFloat(el.dataset.lng)], 18);
            filtered[i].openPopup();
          });
        });
      }
    });
  });

  // --- Toggle sidebar on mobile ---
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.createElement("button");
  toggleBtn.id = "sidebar-toggle";
  toggleBtn.textContent = "‚ò∞";
  toggleBtn.addEventListener("click", () => sidebar.classList.toggle("open"));
  document.body.appendChild(toggleBtn);
})();
</script>
</body>
</html>
