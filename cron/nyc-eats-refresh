#!/usr/bin/env bash
# nyc-eats-refresh — daily rebuild + cross-reference of the NYC Eats site
#
# Runs daily at 3:00 AM ET on the VPS via systemd timer.
#
# What it does:
#   1. Installs/updates Python dependencies
#   2. Runs the build (fetches fresh data from both APIs)
#   3. Runs cross-reference checks (Yelp + Google Places) up to daily limits
#   4. Rebuilds with cross-ref flags baked in
#   5. Copies the built site to the nginx serving directory
#
# Configuration via env vars — see cron/README.md.

set -euo pipefail

# --- Configuration ---
REPO_DIR="${NYC_EATS_REPO:-$HOME/nyc-eats}"
SERVE_DIR="${NYC_EATS_SERVE:-$HOME/nyc-eats-site/dist}"
LOGFILE="${NYC_EATS_LOG:-$HOME/nyc-eats-site/refresh.log}"
VENV="$REPO_DIR/.venv"

# --- Helpers ---
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

# --- Main ---
# When run by systemd, stdout/stderr go to the journal AND
# are appended to $LOGFILE by the service unit.  When run
# manually, redirect to the log file ourselves.
if [ -z "${INVOCATION_ID:-}" ]; then
    exec >> "$LOGFILE" 2>&1
fi

log "=== Starting NYC Eats refresh ==="

cd "$REPO_DIR"

# Ensure venv & deps
if [ ! -d "$VENV" ]; then
    log "Creating virtualenv…"
    python3 -m venv "$VENV"
fi
"$VENV/bin/pip" install -q --upgrade pip
"$VENV/bin/pip" install -q -r requirements.txt

# Build (fresh fetch, no cache)
log "Building site…"
"$VENV/bin/python" build.py -v 2>&1

# Cross-reference: check venues against Yelp & Google Places
# Uses cached results from previous runs; processes up to daily API limits
if [ -n "${YELP_API_KEY:-}" ] || [ -n "${GOOGLE_API_KEY:-}" ]; then
    log "Running cross-reference checks…"
    XREF_START=$(date +%s)
    "$VENV/bin/python" crossref.py 2>&1
    XREF_END=$(date +%s)
    log "Cross-reference completed in $(( XREF_END - XREF_START ))s"

    # Rebuild with updated cross-ref flags
    log "Rebuilding with cross-ref data…"
    "$VENV/bin/python" build.py -v --cache 2>&1
else
    log "No API keys set — skipping cross-reference"
fi

# Deploy to serving directory
log "Syncing to $SERVE_DIR…"
rsync -a --delete --exclude='nginx.conf' --exclude='refresh.log' dist/ "$SERVE_DIR/"

log "=== Refresh complete ($(wc -l < "$REPO_DIR/dist/venues.js" | tr -d ' ') lines in venues.js) ==="
echo ""
